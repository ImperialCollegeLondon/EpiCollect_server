<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <link type="text/css" rel="stylesheet" href="static/styles.css" />
        <style type="text/css">
            #error { text-align: left; color: #ff0000; }
            textarea {vertical-align:top;}
            #projectProperties{border-top:1px solid #e5e9ef; padding-top:5px; margin-top:5px;}
        </style>
        <title>EpiCollect Server - Project Home</title>
        <meta http-equiv="Pragma" content="no-cache" />
        <script type="text/javascript" src="/static/jquery-1.3.2.min.js"></script>
        <script type="text/javascript" src="/static/jquery-ui-1.7.2.min.js"></script>
        <script type="text/javascript">
			var projectKey="";
			var projectName = "";
			var ticket = "";
			var fileState = "";
        	
            function getRequestParameter ( parameterName ) {
                var queryString = window.location.search.substring(1);
                var parameterName = parameterName + "=";
                if ( queryString.length > 0 ) {
                    begin = queryString.indexOf ( parameterName );
                    if ( begin != -1 ) {
                        begin += parameterName.length;
                        end = queryString.indexOf ( "&" , begin );
                        if ( end == -1 ) {
                            end = queryString.length
                        }
                        return unescape ( queryString.substring ( begin, end ) );
                    }
                }
                return "";
            }
            
            $(function() {
                $("#hasForm").hide();
                projectKey=getRequestParameter("key");
                projectName=getRequestParameter("name");
                ticket=getRequestParameter("ticket");
                //$(".projectName").html(projectName);
                var homeURL='http://www.epicollect.net/project.html?name='+projectName;
                $("#homePageLink").html('<a href="'+homeURL+'">'+homeURL+'</a>');
                $("#projectHome a").attr("href", function(){ return "./project.html?key=" + projectKey+"&name="+projectName;});
                $.ajax({
                    type: "GET",
                    url: "validateTicket?ticket="+ticket+"&projectKey="+projectKey+"&projectName="+projectName,
                    dataType: "html",
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                		
                		var browser=navigator.userAgent.toLowerCase();
                		
                		if(XMLHttpRequest.statusText.match(/(Sorry|No project found)/gi)){
                			 window.top.location="/project.html?key="+projectKey+"&name="+projectName; //try to prevent an infinite redirection loop
            			}else{
    	            		if (browser.indexOf("safari")>=0 || browser.indexOf("msie")>=0 || browser.indexOf("opera")>=0)
    	                        window.location="/login-safari.html?firstTime=true&destination=ProjectDescription&projectKey="+projectKey+"&projectName="+projectName; //try to prevent an infinite redirection loop
    	            		else
    	                        window.location="/login.html?firstTime=true&destination=ProjectDescription&projectKey="+projectKey+"&projectName="+projectName; //try to prevent an infinite redirection loop
            			}
                    },
                    success: function (xml, status, req) {
                    	projectKey=getRequestParameter("key");
                    	projectName=getRequestParameter("name");
                    	if((navigator.userAgent.toLowerCase().indexOf("opera")>=0 || navigator.userAgent.toLowerCase().indexOf("safari")>=0) && xml != "ticket validated"){
                    		
                    		if(xml.match(/Sorry/gi)){
                    			 window.top.location="/project.html?key="+projectKey+"&name="+projectName; //try to prevent an infinite redirection loop
                			}else{
                				window.location="/login-safari.html?firstTime=true&destination=ProjectDescription&projectKey="+projectKey+"&projectName="+projectName;
                				return;
                			}
                    	}
                    	
		                $.ajax({
		                    async: false,
		                    cache: false,
		                    type: "POST",
		                    url: "/project.asp",
		                    data: {
		                        "projectKey" : projectKey,
		                        "projectName" : projectName
		                    },
		                    dataType: "json",
		                    error: function (XMLHttpRequest, textStatus, errorThrown) {
		                        $("#error").html("Error: "+errorThrown);
		                    },
		                    success: function (json) {
		                        
		                        if (json.error!="none")
		                            $("#error").html(json.error);
		                        else {
		                            //in case we had the key, not the name
		                            $(".projectName").html(json.projectName);
		                            $(".projectKey").html(json.projectName);
		                            $("#projectProperties").attr("action", "updateProject.asp?projectKey=" + json.projectKey)
		                            $(".projectDescription").html(json.description);
		                            $(".projectDescriptionField").text(json.description);
		                        }
		                    }
		                });
                    }});
                });

            	function removeImgChange()
            	{
					if(!$('input[name=removeImg]').attr("checked"))
					{
						//$('input[name=projectImg]').attr("value", fileState);
						$('input[name=projectImg]').removeAttr("disabled");
					}
					else
					{
						//fileState = $('input[name=projectImg]').attr("value");
						$('input[name=projectImg]').attr("value","");
						$('input[name=projectImg]').attr("disabled","disabled");
					}
					
            	} 
            
        </script>
    
      
    </head>
    <body style="font:Helvetica">
        <div id="container">   
            <a href=".."><img src="http://www.epicollect.net/images/logo_new.png" alt="EC_logo" /></a>
            <div id="nav">
               <!-- <a href="http://www.epicollect.net/beta.html">Home</a>
                <a href="#">Handsets</a>
                <a href="#">Mobile Networks</a>
                <a href="#">General Information</a> 
                <a href="#">Tutorial</a>  
                <a href="#">FAQ</a>-->
            </div>
            <div id="mainbox">
                <div id="content">
                	<div id="projectHome" style="margin-bottom:10px;"><a href="http://www.epicollect.net/project.html?name=" target="_top"><img src="http://www.epicollect.net/images/home_sm.png" alt="project Home" style="vertical-align:bottom;" />Back to project home</a></div>
                    <div id="success"></div>
                    <div id="error"><pre></pre></div>
                    <div id="header">
                        <h1>Update Desctiption and Picture for <span class="projectName"></span></h1>
                    </div>
                    <p>Here you can add an introductory paragraph describing your project - for example, what kind of data you are collecting? the reason you wish people to collect data for your project etc.</p>
					<p>You may also want to include your email address should you wish people to contact you directly. Additionally, you can also upload an image which will be displayed to the top right of your project homepage.</p>
                    <h2>Current Description</h2>
                    <div class="projectDescription"></div>
                    <form id="projectProperties" method="post" action="updateProject.asp" enctype="multipart/form-data">
                        <table>
                            <tr><td><b>New description</b></td><td> <textarea name="projectDescription" class="projectDescriptionField" style="width:400px;height:200px"></textarea></td></tr>
                            <tr><td><b>Project image</b></td><td><input type="file" name="projectImg" id="projectImg" /></td></tr>
                            <tr><td></td><td><input type="checkbox" name="removeImg" onchange="removeImgChange();"></input> To simply remove the existing image check this box</td></tr>
                            <tr><td><input type="submit" value="Save changes" name="submit" /></td><td><input type="reset" name="reset" value="Revert to saved version" /></td></tr>
                        </table>
                    </form>
                </div>
            </div>       
            <div id="footer"></div>
            <div id="foot"> 
                <div align="center"><a href="http://www.imperial.ac.uk/" target="_blank">Hosted and Developed
                    at Imperial College London</a> | <a href="mailto:d.aanensen@imperial.ac.uk">Contact
                    us </a>
                </div>
            </div>
        </div>
    </body>
</html>
